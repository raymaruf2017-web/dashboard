<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Peralatan Mesin Kabupaten Donggala</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 p-6 flex">

<!-- Sidebar -->
<nav class="w-64 bg-white shadow-md border-r border-gray-200 flex flex-col">
  <div class="px-6 py-4 border-b border-gray-200 text-xl font-semibold text-blue-700">ASET DIKBUD</div>

  <!-- Menu Kecamatan Dropdown -->
  <div class="group border-b border-gray-200">
    <button id="kecamatanBtn" class="w-full flex justify-between items-center px-6 py-3 hover:bg-blue-100 focus:outline-none">
      <span class="font-medium text-gray-700">Kecamatan</span>
      <svg id="kecamatanArrow" class="w-4 h-4 text-gray-500 transition-transform" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
      </svg>
    </button>
    <ul id="kecamatanDropdown" class="hidden flex-col border-t border-gray-200 bg-gray-50">
      <!-- Contoh kecamatan -->
      <li data-kecamatan="Banawa" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vRd8vIhHDUbmD6I2aXLX7-_Ysemt2aXA__wKNGoKN0XWWSWCScv5aSmx06H0xkl8g/pub?gid=1917777904&single=true&output=csv" class="px-6 py-2 cursor-pointer hover:bg-blue-50">Banawa</li>
      <li data-kecamatan="Banawa Tengah" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vRnykw5e_i3dwBIeTua-mpFExEJ4w6hROJ5F6OUHiiGpbtunldeKgXlhN_G-D1V8w/pub?gid=1454720232&single=true&output=csv" class="px-6 py-2 cursor-pointer hover:bg-blue-50">Banawa Tengah</li>
      <li data-kecamatan="Banawa Selatan" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vRhDJK33BtCz7KEi6DWgqheZBrcdgK0X9Pw1r28u5ec1MK-I-kP-QOqrsY0G2OnEQ/pub?gid=708970016&single=true&output=csv" class="px-6 py-2 cursor-pointer hover:bg-blue-50">Banawa Selatan</li>
      <li data-kecamatan="Rio Pakava" data-endpoint="URL_CSV_RioPakava" class="px-6 py-2 cursor-pointer hover:bg-blue-50">Rio Pakava</li>
      <li data-kecamatan="Pinembani" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vQshgCYmG0DHxcwLUzhtUamXTYnWb8tR7WQwnJq9k7ldFz_JhV4GHDE-k_dMO_pSA/pub?gid=1860451546&single=true&output=csv" class="px-6 py-2 cursor-pointer hover:bg-blue-50">Pinembani</li>
      <li data-kecamatan="Tanantovea" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vR3MhjBMD3q8UIfOTdAUOHKMdeGcwr3y2YQGFcDmHDd0IVsOsAECl511LsNJ9ynow9cmY4yBpP1jENa/pub?gid=1200528899&single=true&output=csv" class="px-6 py-2 cursor-pointer hover:bg-blue-50">Tanantovea</li>
      <li data-kecamatan="Labuan" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vT7WqNsmpUBIy0-lVm2JdGg1KUKwNgQPpbSyDuuFDwB1aGPY8gsZSBWmxIgiOeJNA/pub?gid=1615242439&single=true&output=csv" class="px-6 py-2 cursor-pointer hover:bg-blue-50">Labuan</li>
      <li data-kecamatan="Sindue" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2sjcmJjTCYD3p6-7pDQTmm3mCVphZIP2-5DGZOHxStucexMcdqPVsfsbnDouFcA/pub?gid=1920885371&single=true&output=csv" class="px-6 py-2 cursor-pointer hover:bg-blue-50">Sindue</li>
      <li data-kecamatan="Sindue Tombusabora" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vRYHOyrOQ_hNjC1L1FoIMVbbWES0dPGb1OaU6V--PV_lm0O97IHFvtPRhgRNXn_dA/pub?gid=1974330298&single=true&output=csv" class="px-6 py-2 cursor-pointer hover:bg-blue-50">Sindue Tombusabora</li>
      <li data-kecamatan="Sindue Tobata" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vQIbvzs-jZRcf1z0uV_Ahwh6dNdBgBHw66T358D9wd0-DHimDs8r4ajCvZwLa8Srg/pub?gid=801352666&single=true&output=csv" class="px-6 py-2 cursor-pointer hover:bg-blue-50">Sindue Tobata</li>
      <li data-kecamatan="Sirenja" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vROhU6H6reNQxHKsAmYYgfcaSZyis1vALTmBkYhjAp7BGX_wNdA2cVdgOjFQIIgjQ/pub?output=csv" class="px-6 py-2 cursor-pointer hover:bg-blue-50">Sirenja</li>
      <li data-kecamatan="Balaesang" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vQIf6mV6qgS6fmRe3jz305N8wCDdKWJcKKWSxHtybbo7xoERx15unD-x4rgyFxF-g/pub?gid=1401841928&single=true&output=csv" class="px-6 py-2 cursor-pointer hover:bg-blue-50">Balaesang</li>
      <li data-kecamatan="Balaesang Tanjung" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vQRojLHXJ4W6IEdiNn34kZrMgr5QvPZllm85-sbgD0WxjG6vFMUMQz3QzzGnM-7pw/pub?gid=820099832&single=true&output=csv" class="px-6 py-2 cursor-pointer hover:bg-blue-50">Balaesang Tanjung</li>
      <li data-kecamatan="Dampelas" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vR_BmCgfv-HOMRKzNMZ1aHL05CZsR7Ie0VZGRJTD29tX1C-ANiKASW1hB_PM69WuQ/pub?gid=1489077321&single=true&output=csv" class="px-6 py-2 cursor-pointer hover:bg-blue-50">Dampelas</li>
      <li data-kecamatan="Sojol" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vT64A3AbrmT4TK8fLj5ctUc3LLMESXVTOuw3nBd2qRTEFIljaxTBW3-Z5u4w7W2Ng/pub?gid=1781390946&single=true&output=csv" class="px-6 py-2 cursor-pointer hover:bg-blue-50">Sojol</li>
      <li data-kecamatan="Sojol Utara" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vT41KwECicPb2EY8d8BP1f73RM3dhVWYDOxpaFlHZluKFy9owLzyVX7N7mIUm37Tw/pub?gid=502544387&single=true&output=csv" class="px-6 py-2 cursor-pointer hover:bg-blue-50">Sojol Utara</li>
    </ul>
  </div>
</nav>

<!-- Main Content -->
<main class="flex-1 p-6">
  <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4 gap-2">
    <h1 class="text-xl font-bold">Data Peralatan Mesin Kabupaten Donggala</h1>
    <div class="flex gap-2">
      <input id="searchInput" type="text" placeholder="Cari data..." class="px-3 py-2 border rounded focus:outline-none focus:ring focus:border-blue-300">
      <button id="btnPdf" class="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600">PDF</button>
      <button id="btnExcel" class="px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600">Excel</button>
    </div>
  </div>

  <div id="outputWrapper" class="bg-white border rounded shadow overflow-x-auto max-h-[600px] overflow-y-auto">
    <div id="output" class="min-w-[800px]">
      <p class="p-4">Memuat data...</p>
    </div>
  </div>
</main>

<script>
// Variabel global
const kecamatanDropdown = document.getElementById('kecamatanDropdown');
const kecamatanBtn = document.getElementById('kecamatanBtn');
const kecamatanArrow = document.getElementById('kecamatanArrow');
const output = document.getElementById('output');
const searchInput = document.getElementById('searchInput');

let dataAll = [];
let filteredData = [];

// Toggle dropdown kecamatan
kecamatanBtn.addEventListener('click', () => {
  kecamatanDropdown.classList.toggle('hidden');
  kecamatanArrow.classList.toggle('rotate-180');
});

// Fetch data CSV
kecamatanDropdown.addEventListener('click', (e) => {
  if (e.target.tagName === 'LI') {
    const endpoint = e.target.getAttribute('data-endpoint');
    fetch(endpoint)
      .then(res => res.text())
      .then(text => {
        const cleanCSV = text.replace(/^\uFEFF/, '').trim();
        Papa.parse(cleanCSV, {
          header: true,
          skipEmptyLines: true,
          complete: results => {
            dataAll = results.data;
            filteredData = [...dataAll];
            renderTable(filteredData);
          },
          error: err => output.innerHTML = `<p class="p-4 text-red-500">Gagal parse CSV: ${err}</p>`
        });
      })
      .catch(err => output.innerHTML = `<p class="p-4 text-red-500">Gagal fetch CSV: ${err}</p>`);
  }
});

// Pencarian
searchInput.addEventListener('input', () => {
  const kw = searchInput.value.toLowerCase();
  filteredData = dataAll.filter(row =>
    Object.values(row).some(val => val?.toString().toLowerCase().includes(kw))
  );
  renderTable(filteredData);
});

// Render tabel
function renderTable(data) {
  if (!data.length) {
    output.innerHTML = '<p class="p-4 text-gray-500">Data kosong.</p>';
    return;
  }

  const cols = Object.keys(data[0]);
  // Hanya kolom A,B,K–AB (index 0,1,10–27)
  const visibleCols = cols.filter((c, i) => i === 0 || i === 1 || (i >= 10 && i <= 27));

  let table = '<table id="dataTable" class="min-w-full border border-gray-300 text-sm table-auto">';
  table += '<thead class="bg-gray-200 sticky top-0 z-10"><tr>';
  visibleCols.forEach(c => table += `<th class="border px-2 py-1 text-center whitespace-nowrap">${c}</th>`);
  table += '</tr></thead><tbody>';

  data.forEach(row => {
    table += '<tr>';
    visibleCols.forEach(c => table += `<td class="border px-2 py-1 whitespace-nowrap">${row[c] || ''}</td>`);
    table += '</tr>';
  });

  table += '</tbody></table>';
  output.innerHTML = table;
}

// Export PDF
document.getElementById('btnPdf').addEventListener('click', () => {
  if (!filteredData.length) return alert('Data kosong.');
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const allCols = Object.keys(filteredData[0]);
  const selectedCols = allCols.filter((col, idx) => idx === 0 || idx === 1 || (idx >= 10 && idx <= 27));

  const headers = [selectedCols];
  const rows = filteredData.map(row => selectedCols.map(c => row[c] || ''));

  doc.autoTable({
    head: headers,
    body: rows,
    styles: { fontSize: 8 },
    headStyles: { fillColor: [59, 130, 246] },
  });
  doc.save('data.pdf');
});

// Export Excel
document.getElementById('btnExcel').addEventListener('click', () => {
  if (!filteredData.length) return alert('Data kosong.');

  const allCols = Object.keys(filteredData[0]);
  const selectedCols = allCols.filter((col, idx) => idx === 0 || idx === 1 || (idx >= 10 && idx <= 27));

  const exportData = filteredData.map(row => {
    const obj = {};
    selectedCols.forEach(c => obj[c] = row[c] || '');
    return obj;
  });

  const ws = XLSX.utils.json_to_sheet(exportData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Data");
  XLSX.writeFile(wb, "data.xlsx");
});
</script>

</body>

</html>
